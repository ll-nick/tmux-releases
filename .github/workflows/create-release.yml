name: create-release

on:
  # Create a stable release
  push:
    tags:
      - 'v*'
  # Create a preview release
  schedule:
    - cron: '0 5 * * *'
  workflow_dispatch:

env:
  PREFIX: /tmp/build

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      is_preview: ${{ steps.set_type.outputs.is_preview }}
      nightly_requires_rebuild: ${{ steps.tmux_head.outputs.nightly_requires_rebuild }}
      tmux_sha: ${{ steps.tmux_head.outputs.tmux_sha }}
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Determine build type
        id: set_type
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "is_preview=false" >> $GITHUB_OUTPUT
          else
            echo "is_preview=true" >> $GITHUB_OUTPUT
          fi

      - name: Fetch latest tmux master
        id: tmux_head
        if: ${{ steps.set_type.outputs.is_preview == 'true' }}
        run: |
          git clone --depth 1 https://github.com/tmux/tmux.git
          cd tmux
          HEAD_SHA=$(git rev-parse --short=8 HEAD)
          echo "tmux_sha=$HEAD_SHA" >> "$GITHUB_OUTPUT"

      - name: Checkout repo
        if: ${{ steps.set_type.outputs.is_preview == 'true' }}
        uses: actions/checkout@v4

      - name: Determine if build is needed
        if: ${{ steps.set_type.outputs.is_preview == 'true' }}
        env:
          HEAD_SHA: ${{ steps.tmux_head.outputs.tmux_sha }}
        run: |
          # Get last preview release SHA (if it exists)
          LAST_SHA=$(gh release view preview --json body -q '.body' 2>/dev/null | grep -oE 'SHA: [0-9a-f]+' | cut -d' ' -f2 || echo "")
          if [ "$HEAD_SHA" = "$LAST_SHA" ]; then
            echo "No changes since last preview build, skipping."
            echo "nightly_requires_rebuild=false" >> "$GITHUB_OUTPUT"
          else
            echo "New commit detected, building..."
            echo "nightly_requires_rebuild=true" >> "$GITHUB_OUTPUT"
          fi


  build:
    name: Build tmux (${{ matrix.os }}-${{ matrix.arch }})
    needs: setup
    if: ${{ needs.setup.outputs.is_preview == 'false' ||
            needs.setup.outputs.nightly_requires_rebuild == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            arch: x86_64
            runs_on: ubuntu-24.04
          - os: linux
            arch: arm64
            runs_on: ubuntu-24.04-arm
          - os: macos
            arch: x86_64
            runs_on: macos-15-intel
          - os: macos
            arch: arm64
            runs_on: macos-15


    runs-on: ${{ matrix.runs_on }}

    steps:
      - name: Install build dependencies (Linux)
        if: matrix.os == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
              automake \
              bison \
              build-essential \
              git \
              tar \
              pkg-config \
              wget

      - name: Install build dependencies (macOS)
        if: matrix.os == 'macos'
        run: |
          brew update
          brew install \
              automake \
              bison \
              git

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set versions
        run: |
          echo "Loading versions from versions.env"
          source versions.env
          echo "MUSL_VERSION=$MUSL_VERSION" >> "$GITHUB_ENV"
          echo "LIBEVENT_VERSION=$LIBEVENT_VERSION" >> "$GITHUB_ENV"
          echo "NCURSES_VERSION=$NCURSES_VERSION" >> "$GITHUB_ENV"
          echo "UTF8PROC_VERSION=$UTF8PROC_VERSION" >> "$GITHUB_ENV"

          if [ "${{ needs.setup.outputs.is_preview }}" = "true" ]; then
            echo "TMUX_VERSION=preview" >> "$GITHUB_ENV"
          else
            VERSION="${GITHUB_REF_NAME#v}"
            echo "TMUX_VERSION=$VERSION" >> "$GITHUB_ENV"
          fi

      - name: Build musl
        if: matrix.os == 'linux'
        run: |
          ./scripts/build_musl.sh
          echo "CC=${PREFIX}/bin/musl-gcc -static" >> "$GITHUB_ENV"

      - name: Build libevent
        run: ./scripts/build_libevent.sh

      - name: Build ncurses
        run: ./scripts/build_ncurses.sh

      - name: Build utf8proc
        if: matrix.os == 'macos'
        run: ./scripts/build_utf8proc.sh

      - name: Build tmux
        run: ./scripts/build_tmux.sh

      - name: Verify tmux binary
        run: |
          ./scripts/verify_tmux.sh

      - name: Determine archive name
        id: archive_name
        run: |
         if [ "${{ needs.setup.outputs.is_preview }}" = "true" ]; then
            VERSION="${{ needs.setup.outputs.tmux_sha }}"
          else
            VERSION="${GITHUB_REF_NAME}"
          fi
          echo "archive_name=tmux-${VERSION}-${{ matrix.os }}-${{ matrix.arch }}.tar.gz" >> "$GITHUB_OUTPUT"

      - name: Archive tmux binary
        run: |
          tar -czf "${{ steps.archive_name.outputs.archive_name }}" -C ${{ env.PREFIX }}/bin tmux

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.archive_name.outputs.archive_name }}
          path: ${{ steps.archive_name.outputs.archive_name }}


  collect-licenses:
    runs-on: ubuntu-latest
    needs: setup
    if: ${{ needs.setup.outputs.is_preview == 'false' || needs.setup.outputs.nightly_requires_rebuild == 'true' }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set TMUX_VERSION
        run: |
          if [ "${{ needs.setup.outputs.is_preview }}" = "true" ]; then
            echo "TMUX_VERSION=preview" >> "$GITHUB_ENV"
          else
            VERSION="${GITHUB_REF_NAME#v}"
            echo "TMUX_VERSION=$VERSION" >> "$GITHUB_ENV"
          fi

      - name: Collect licenses
        run: |
          ./scripts/collect_licenses.sh

      - name: Upload licenses artifact
        uses: actions/upload-artifact@v4
        with:
          name: LICENSES.tar.gz
          path: ${{ env.PREFIX }}/LICENSES.tar.gz


  create-release:
    needs: [setup, build, collect-licenses]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Clone Repo
        uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          merge-multiple: true
          path: dist

      - name: Create release
        env:
          IS_PREVIEW: ${{ needs.setup.outputs.is_preview }}
          TMUX_SHA: ${{ needs.setup.outputs.tmux_sha }}
        run: |
          if [ "$IS_PREVIEW" = "true" ]; then
            NOTES="Preview builds of tmux (SHA: $TMUX_SHA) for Linux (musl) and macOS."
            gh release delete preview --yes || true
            gh release create preview \
              --prerelease \
              --title "tmux preview (SHA: $TMUX_SHA)" \
              --notes "$NOTES" \
              dist/*
          else
            NOTES="Static builds of tmux version ${GITHUB_REF_NAME#v} for Linux (musl) and macOS."
            gh release create $GITHUB_REF_NAME \
              --title "tmux ${GITHUB_REF_NAME}" \
              --notes "$NOTES" \
              dist/*
          fi

